pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
-- Make PICO-8 and Lua more "OOP-ish" (part 2)

-- variables
--  player
local debug = true
local pills
local bullets
local score
local player


-- game loop
function _init()
    score = 0
    nPills = 5
    player = {
        x = 64,
        y = 64,
        dx = 1,
        dy = 1,
        spr = 1,
        width = 8,
        height = 8,
        isVertAlign = false,
        isHorizAlign = false,
        update = function(self)
            if btn(0) then
                self.x -=self.dx
                self.spr = 4 + rnd(2)
            end
            if btn(1) then
                self.x +=self.dx
                self.spr = 4 + rnd(2)
            end
            if btn(2) then
                self.y -=self.dy
                self.spr = 6 + rnd(3)
            end
            if btn(3) then
                self.y +=self.dy
                self.spr = 1 + rnd(3)
            end
        end,
        draw = function(self)
            spr(self.spr, self.x, self.y)
            if (debug) then rect(self.x - 1, self.y - 1, self.x + self.width, self.y + self.height, 8) end
        end,
        checkCollision = function(self, pill)
            if boundingBoxesOverlapping(self, pill) and not pill.isCollected then
                pill.isCollected = true
                score += 1
            end
        end
    }

    pills = {}
    for i = 1, nPills do
        pills[i] = makePills(flr(rnd(120) + 1), flr(rnd(120) + 1))
    end
end

function _update()
    player:update()

    local pill
    for pill in all(pills) do
        pill:update()
        player:checkCollision(pill)
    end

    if btn(4) then
        makeBullets(player)
    end

    for b in all(bullet) do
       b:update()
    end
end


function _draw()
    cls()
    print("score: "..score, 5, 5, 7)
    player:draw()

    local pill
    for pill in all(pills) do
        pill:draw()
    end

    for b in all(bullet) do
        b:draw()
    end
end

function makePills(x, y)
    local pill = {
        x = x,
        y = y,
        width = 7,
        height = 7,
        isCollected = false,
        update = function(self)
        end,
        draw = function(self)
            if not self.isCollected then
                spr(48, self.x, self.y)

                if (debug) then
                    rect(self.x, self.y, self.x + self.width, self.y + self.height, 10)
                end
            end
        end
    }

    return pill
end

function makeBullets(object)
    local bullet = {
        x = object.x,
        y = object.y,
        dx = 0,
        dy = -4,
        life = 60,
        draw = function(self)
            pset(self.x, self.y, 10)
        end,
        update = function(self)
            self.x += self.dx
            self.y += self.dy
            self.life -= 1
            if self.life < 0 then
                del(bullet, self)
            end
        end
    }

    return bullet
end


-- hit detection methods
function linesOverlapping(min1,max1,min2,max2)
    return max1>min2 and max2>min1
end

function rectsOverlapping(left1,top1,right1,bottom1,left2,top2,right2,bottom2)
    return linesOverlapping(left1,right1,left2,right2) and linesOverlapping(top1,bottom1,top2,bottom2)
end

function boundingBoxesOverlapping(obj1,obj2)
    return rectsOverlapping(obj1.x,obj1.y,obj1.x+obj1.width,obj1.y+obj1.height,obj2.x,obj2.y,obj2.x+obj2.width,obj2.y+obj2.height)
end




__gfx__
00000000000990000009900000099000000990000009900000099000000990000009900000099000000990000009900000099010000990000000000000000000
00000000000ff000000ff000000ff000000ff000000ff000000990000009900000099000000ff000000ff000000ff00000099110000991000000000000000000
0070070000999900009999f00f999900000990000009900000959900009599f00f95990000f99f000009d10000099000000591d0000591000000000000000000
000770000f0990f000f9900dd0099f00000f90000df99fd00f0950f000f9500dd0095f000f11f000000f1110000f111100095f0000095f000000000000000000
000770000d0550d000fd50000005df00000f5000000550000d0550d000f5500000055f00001150000005fd110005fd1100055000000551000000000000000000
007007000005500000055d0000d55000000d50000d9559d00005500000055d0000d5500000055000000550000005500000055000000550000000000000000000
00000000000990000090000000000900000990000000000000099000009000000000090000099000000990000009900000099000000990000000000000000000
00000000000dd0000d000000000000d0000dd00000000000000dd0000d000000000000d0000dd000000dd000000dd000000dd000000dd0000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000990000aaa9aa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000d300000000d00009a9900007aa900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5dddddd544ddddd50099990000888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d0dd700040dd45d000a7aa0000878800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
005005000050440000a7aa0000878800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
005000000000000000aaaa0000888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000099990000888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000dddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000000aa0000dd7ddd0088008800dddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0087480000a79a000d6dd5d087788888dd6666dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0088480000aa9a000d6dd5d087888288d668666d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0077d70000aa9a000dddd5d088888288d668886d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007dd70000a99a0000dd5d0008882880d688866d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000aa00000dddd0000888800d666866d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000dd00000088000d666666d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
